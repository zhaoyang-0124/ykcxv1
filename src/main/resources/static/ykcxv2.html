<!-- index.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>严考促学考试系统</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .question { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .options { margin: 10px 0; }
        .option { margin: 5px 0; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-success { background: #28a745; color: white; border: none; }
        .btn-info { background: #17a2b8; color: white; border: none; }
        .btn-warning { background: #ffc107; color: white; border: none; }
        .btn-return {background: #28a745; color: white; border: none}
        .result { text-align: center; font-size: 24px; margin: 20px 0; }
        .hidden { display: none; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* 答题卡样式 */
        .card-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        /* 计时器样式 */
        .timer-container {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .timer-warning {
            background: #ffc107 !important;
            color: #000 !important;
        }

        .card-item {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            cursor: pointer;
            border-radius: 3px;
        }
        .card-item:not(.answered) { background: #f8f9fa; }
        .card-item.answered { background: #28a745; color: white; }
        .card-item.current { background: #007bff; color: white; }

        /* 考号输入样式 */
        .exam-number-section {
            text-align: center;
            margin: 30px 0;
        }
        .exam-number-input {
            padding: 10px;
            font-size: 16px;
            width: 300px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* 切屏警告样式 */
        .screen-switch-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffc107;
            color: #000;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            display: none;
        }

        .warning-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
<div class="container">

    <!-- 返回mainbody.html -->
    <div id="returnSection">
        <a href="mainbody.html" class="btn btn-success">返回上一级</a>
    </div>

    <h1>在线考试系统</h1>

    <!-- 计时器 -->
    <div id="timerContainer" class="timer-container hidden">
        <span>剩余时间: </span>
        <span id="timerDisplay">30:00</span>
    </div>

    <!-- 系统状态 -->
    <div id="statusSection">
        <h2>系统状态</h2>
        <div id="statusInfo" class="status">正在检查系统状态...</div>
        <div id="questionStats" class="status info hidden"></div>
    </div>

    <!-- 考号输入区域 -->
    <div id="examNumberSection" class="exam-number-section hidden">
        <h2>请输入考号</h2>
        <input type="text" id="examNumberInput" class="exam-number-input" placeholder="输入您的考号">
        <button class="btn btn-success" onclick="startExam()">开始考试</button>
    </div>

    <!-- 开始答题 -->
    <div id="startSection" class="hidden">
        <h2>准备答题</h2>
        <p>点击开始答题，系统将从题库中随机抽取85道题目（45道单选，20道多选，20道判断）</p>
        <p>答题时间：<strong>30分钟</strong></p>
        <p><strong style="color: #dc3545;">注意：切屏超过3次将自动提交答案！</strong></p>
        <button class="btn btn-success" onclick="startQuiz()">开始答题</button>
    </div>

    <!-- 答题区域 -->
    <div id="quizSection" class="hidden">
        <h2>答题中</h2>
        <div id="progressInfo"></div>
        <button class="btn btn-info" onclick="showCard()">答题卡</button>
        <div id="questionContainer"></div>
        <button class="btn btn-primary" onclick="prevQuestion()" id="prevBtn">上一题</button>
        <button class="btn btn-primary" onclick="nextQuestion()" id="nextBtn">下一题</button>
        <button class="btn btn-success" onclick="submitQuiz()">提交答案</button>
    </div>

    <!-- 答题卡弹窗 -->
    <div id="cardOverlay" class="overlay hidden" onclick="closeCard()"></div>
    <div id="cardPanel" class="card-panel hidden">
        <h3>答题卡</h3>
        <div id="cardGrid" class="card-grid"></div>
        <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-primary" onclick="closeCard()">关闭</button>
        </div>
    </div>

    <!-- 结果区域 -->
    <div id="resultSection" class="hidden">
        <div class="result">
            <h2>答题完成！</h2>
            <p>您的得分：<span id="totalScore"></span> 分</p>
            <button class="btn btn-success" onclick="location.reload()">重新开始</button>
        </div>
    </div>

    <!-- 错题查看区域 -->
    <div id="wrongAnswersSection" class="hidden">
        <h2>错题回顾</h2>
        <div id="wrongAnswersContainer"></div>
        <button class="btn btn-primary" onclick="backToResult()">返回结果</button>
    </div>

    <!-- 切屏警告 -->
    <div id="warningOverlay" class="warning-overlay"></div>
    <div id="screenSwitchWarning" class="screen-switch-warning">
        <p>检测到切屏操作！</p>
        <p>已切屏 <span id="switchCount">0</span> 次，超过3次将自动提交答案！</p>
        <p>请专心答题，不要离开考试页面！</p>
    </div>
</div>

<script>
    let currentSession = null;
    let currentQuestionIndex = 0;
    let timerInterval = null;
    let remainingTime = 30 * 60; // 30分钟，以秒为单位
    let currentExamNumber = ''; // 用于存储考号
    let screenSwitchCount = 0; // 切屏次数
    let screenSwitchWarningTimeout = null; // 切屏警告定时器
    let isScreenSwitchSubmitting = false; // 标记是否是切屏导致的提交
    let isPageHidden = false; // 标记页面是否隐藏

    // 记录答案与锁定状态
    const answersByQid = new Map();     // questionId -> string[]
    let questions = [];                 // 题目数组缓存
    let questionResults = [];           // 答题结果缓存

    window.onload = function() {
        checkSystemStatus();
    };

    async function checkSystemStatus() {
        try {
            const response = await fetch('http://localhost:8989/jinzhouport/api/quiz/status');
            if (response.ok) {
                const status = await response.json();
                const statusDiv = document.getElementById('statusInfo');
                const statsDiv = document.getElementById('questionStats');

                if (status.fileStatus.fileExists) {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = '题库文件加载成功';


                    // 显示考号输入界面
                    document.getElementById('examNumberSection').classList.remove('hidden');
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.textContent = '题库文件不存在，请检查文件路径配置';
                }
            } else {
                document.getElementById('statusInfo').className = 'status error';
                document.getElementById('statusInfo').textContent = '系统连接失败';
            }
        } catch (error) {
            document.getElementById('statusInfo').className = 'status error';
            document.getElementById('statusInfo').textContent = '系统连接失败: ' + error.message;
        }
    }

    function startExam() {
        // 获取考号
        currentExamNumber = document.getElementById('examNumberInput').value.trim();

        if (!currentExamNumber) {
            alert('请输入考号');
            return;
        }

        // 隐藏考号输入界面
        document.getElementById('examNumberSection').classList.add('hidden');
        document.getElementById('startSection').classList.remove('hidden');
    }

    async function startQuiz() {
        if (!currentExamNumber) {
            alert('请先输入考号');
            return;
        }

        try {
            const response = await fetch('http://localhost:8989/jinzhouport/api/quiz/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ examNumber: currentExamNumber })
            });
            const result = await response.json();

            if (result.success) {
                currentSession = { sessionId: result.sessionId };
                document.getElementById('startSection').classList.add('hidden');
                document.getElementById('quizSection').classList.remove('hidden');
                document.getElementById('timerContainer').classList.remove('hidden');

                await loadQuestions();

                // 开始计时
                startTimer();

                // 开始切屏检测
                startScreenSwitchDetection();
            } else {
                alert('开始答题失败: ' + (result.error || '未知错误'));
            }
        } catch (error) {
            alert('开始答题失败: ' + error.message);
        }
    }

    // 切屏检测功能
    function startScreenSwitchDetection() {
        // 监听页面可见性变化
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // 页面隐藏（切屏出去）
                isPageHidden = true;
            } else {
                // 页面显示（切屏回来）
                if (isPageHidden) {
                    // 从隐藏状态变为显示状态，算一次完整的切屏
                    screenSwitchCount++;
                    showScreenSwitchWarning();

                    if (screenSwitchCount >= 3) {
                        // 切屏超过3次，自动提交
                        setTimeout(() => {
                            submitQuizByScreenSwitch();
                        }, 100); // 延迟执行，确保警告显示
                    }
                }
                isPageHidden = false;
            }
        });

        // 监听页面焦点变化
        window.addEventListener('blur', function() {
            // 窗口失去焦点（切屏出去）
            isPageHidden = true;
        });

        window.addEventListener('focus', function() {
            // 窗口获得焦点（切屏回来）
            if (isPageHidden) {
                // 从失去焦点状态变为获得焦点状态，算一次完整的切屏
                screenSwitchCount++;
                showScreenSwitchWarning();

                if (screenSwitchCount >= 3) {
                    // 切屏超过3次，自动提交
                    setTimeout(() => {
                        submitQuizByScreenSwitch();
                    }, 100); // 延迟执行，确保警告显示
                }
            }
            isPageHidden = false;
        });
    }

    // 显示切屏警告
    function showScreenSwitchWarning() {
        const warningDiv = document.getElementById('screenSwitchWarning');
        const overlay = document.getElementById('warningOverlay');
        const switchCountSpan = document.getElementById('switchCount');

        // 更新切屏次数显示
        switchCountSpan.textContent = screenSwitchCount;

        // 显示警告
        warningDiv.style.display = 'block';
        overlay.style.display = 'block';

        // 清除之前的定时器
        if (screenSwitchWarningTimeout) {
            clearTimeout(screenSwitchWarningTimeout);
        }

        // 2秒后隐藏警告
        screenSwitchWarningTimeout = setTimeout(function() {
            warningDiv.style.display = 'none';
            overlay.style.display = 'none';
        }, 2000);
    }

    // 通过切屏触发的提交
    async function submitQuizByScreenSwitch() {
        if (isScreenSwitchSubmitting) return; // 防止重复提交
        isScreenSwitchSubmitting = true;

        // 清除计时器
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // 提交当前页面未保存的答案
        if (questions && questions[currentQuestionIndex]) {
            const currentQ = questions[currentQuestionIndex];
            const inputs = document.querySelectorAll(`input[name="q${currentQ.id}"]`);
            const chosen = [];
            inputs.forEach(i => { if (i.checked) chosen.push(i.value); });
            answersByQid.set(currentQ.id, chosen);
        }

        try {
            const response = await fetch(`http://localhost:8989/jinzhouport/api/quiz/finish?sessionId=${currentSession.sessionId}`, {
                method: 'POST'
            });

            if (response.ok) {
                const result = await response.json();
                const score = result.totalScore || 0;

                // 显示分数并询问是否提交最终成绩
                const confirmation = confirm(`检测到切屏超过3次，考试已自动提交！\n\n您的得分：${score} 分\n\n是否提交最终成绩？`);

                if (confirmation) {
                    // 触发submitFinalScore函数
                    await submitFinalScore(score);
                } else {
                    // 取消提交则直接跳转
                    window.location.href = 'mainbody.html';
                }
            } else {
                throw new Error('提交失败');
            }
        } catch (error) {
            console.error('提交失败:', error);
            alert('提交失败，系统将返回主页面。');
            window.location.href = 'mainbody.html';
        }
    }

    async function loadQuestions() {
        try {
            const response = await fetch(`http://localhost:8989/jinzhouport/api/quiz/session/${currentSession.sessionId}/questions`);
            if (response.ok) {
                const sess = await response.json();
                currentSession = sess;
                questions = sess.questions || [];
                currentQuestionIndex = 0;
                showQuestion();
                updateCard(); // 初始化答题卡
            } else {
                alert('加载题目失败');
            }
        } catch (error) {
            alert('加载题目失败: ' + error.message);
        }
    }

    function showQuestion() {
        if (!questions || questions.length === 0) return;
        if (currentQuestionIndex < 0) currentQuestionIndex = 0;
        if (currentQuestionIndex >= questions.length) { submitQuiz(); return; }

        const q = questions[currentQuestionIndex];
        const container = document.getElementById('questionContainer');
        const progressDiv = document.getElementById('progressInfo');

        progressDiv.innerHTML = `第 ${currentQuestionIndex + 1} 题 / 共 ${questions.length} 题`;

        // 本题是否已保存答案（回显）
        const saved = answersByQid.get(q.id) || [];

        container.innerHTML = `
            <div class="question">
                <h3>第${currentQuestionIndex + 1}题 (${getTypeName(q.type)})</h3>
                <p>${q.content}</p>
                <div class="options">
                    ${(q.options || []).map(opt => `
                        <div class="option">
                            <label>
                                <input
                                    type="${q.type === 2 ? 'checkbox' : 'radio'}"
                                    name="q${q.id}"
                                    value="${opt.key}"
                                    ${saved.includes(opt.key) ? 'checked' : ''}>
                                ${opt.key}. ${opt.text}
                            </label>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        // 更新按钮状态
        document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
        document.getElementById('nextBtn').textContent =
            currentQuestionIndex === questions.length - 1 ? '提交' : '下一题';

        updateCard(); // 更新答题卡
    }

    function getTypeName(type) {
        switch(type) {
            case 1: return '单选题';
            case 2: return '多选题';
            case 3: return '判断题';
            default: return '未知';
        }
    }

    async function nextQuestion() {
        const q = questions[currentQuestionIndex];
        if (!q) return;

        // 采集当前答案并提交到后端
        const inputs = document.querySelectorAll(`input[name="q${q.id}"]`);
        const chosen = [];
        inputs.forEach(i => { if (i.checked) chosen.push(i.value); });

        // 保存到本地映射
        answersByQid.set(q.id, chosen);

        // 提交到后端
        try {
            const response = await fetch('http://localhost:8989/jinzhouport/api/quiz/answer', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sessionId: currentSession.sessionId,
                    questionId: q.id,
                    answers: chosen
                })
            });
        } catch (err) {
            console.error('提交答案失败:', err);
        }

        // 下一题
        if (currentQuestionIndex >= questions.length - 1) {
            submitQuiz();
        } else {
            currentQuestionIndex++;
            showQuestion();
        }
    }

    function prevQuestion() {
        // 回到上一题，可以修改答案
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            showQuestion();
        }
    }

    async function submitQuiz() {
        // 如果是切屏触发的提交，直接返回
        if (isScreenSwitchSubmitting) return;

        // 清除计时器
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        // 提交当前页面未保存的答案
        const currentQ = questions[currentQuestionIndex];
        if (currentQ) {
            const inputs = document.querySelectorAll(`input[name="q${currentQ.id}"]`);
            const chosen = [];
            inputs.forEach(i => { if (i.checked) chosen.push(i.value); });
            answersByQid.set(currentQ.id, chosen);
        }

        try {
            const response = await fetch(`http://localhost:8989/jinzhouport/api/quiz/finish?sessionId=${currentSession.sessionId}`, {
                method: 'POST'
            });
            if (response.ok) {
                const result = await response.json();
                const score = result.totalScore;
                document.getElementById('totalScore').textContent = score;

                // 显示成绩确认弹窗（关键修改点）
                const confirmation = confirm(`考试结束！\n您的得分：${score} 分\n\n是否提交本次成绩？\n（提交后成绩将计入系统）`);

                if (confirmation) {
                    // 提交最终成绩
                    await submitFinalScore(score);
                } else {
                    // 放弃提交，返回主页面
                    alert('已放弃提交成绩。考试结束，系统将返回主页面。');
                    location.href = 'mainbody.html';
                }
            }
        } catch (error) {
            alert('提交失败: ' + error.message);
        }
    }

    // 计时器功能
    function startTimer() {
        // 重置剩余时间
        remainingTime = 30 * 60; // 30分钟

        // 更新显示
        updateTimerDisplay();

        // 清除可能存在的旧计时器
        if (timerInterval) {
            clearInterval(timerInterval);
        }

        // 开始计时
        timerInterval = setInterval(() => {
            remainingTime--;

            if (remainingTime <= 0) {
                // 时间到，自动提交
                clearInterval(timerInterval);
                timerInterval = null;

                // 显示提示
                alert('答题时间已到，系统将自动提交答案！');

                // 自动提交
                submitQuiz();
            } else {
                updateTimerDisplay();
            }
        }, 1000); // 每秒更新一次
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;

        const display = document.getElementById('timerDisplay');
        display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // 当时间少于5分钟时，改变颜色提醒用户
        const timerContainer = document.getElementById('timerContainer');
        if (remainingTime <= 5 * 60) { // 5分钟
            timerContainer.classList.add('timer-warning');
        } else {
            timerContainer.classList.remove('timer-warning');
        }
    }

    async function submitFinalScore(score) {
        try {
            const response = await fetch('http://localhost:8989/jinzhouport/api/exam/results', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    examNumber: currentExamNumber,
                    score: score
                })
            });

            if (response.ok) {
                // 显示提交成功提示
                alert('成绩已成功提交！系统将自动返回主页面。');
                location.href = 'mainbody.html';
            } else {
                throw new Error('最终提交失败: ' + (await response.text()));
            }
        } catch (error) {
            alert('提交失败: ' + error.message);
        }
    }

    // 答题卡功能
    function showCard() {
        const cardGrid = document.getElementById('cardGrid');
        cardGrid.innerHTML = '';

        questions.forEach((q, index) => {
            const cardItem = document.createElement('div');
            cardItem.className = 'card-item';
            cardItem.textContent = index + 1;

            // 标记已答题的题目
            if (answersByQid.has(q.id) && answersByQid.get(q.id).length > 0) {
                cardItem.classList.add('answered');
            }

            // 标记当前题
            if (index === currentQuestionIndex) {
                cardItem.classList.add('current');
            }

            cardItem.onclick = () => {
                jumpToQuestion(index);
            };

            cardGrid.appendChild(cardItem);
        });

        document.getElementById('cardOverlay').classList.remove('hidden');
        document.getElementById('cardPanel').classList.remove('hidden');
    }

    function closeCard() {
        document.getElementById('cardOverlay').classList.add('hidden');
        document.getElementById('cardPanel').classList.add('hidden');
    }

    function jumpToQuestion(index) {
        // 保存当前题的答案
        const currentQ = questions[currentQuestionIndex];
        if (currentQ) {
            const inputs = document.querySelectorAll(`input[name="q${currentQ.id}"]`);
            const chosen = [];
            inputs.forEach(i => { if (i.checked) chosen.push(i.value); });
            answersByQid.set(currentQ.id, chosen);
        }

        currentQuestionIndex = index;
        showQuestion();
        closeCard();
    }

    function updateCard() {
        // 这个函数可以在需要时更新答题卡状态
    }

    // 错题查看功能 - 已移除
    // function reviewWrongAnswers() { ... }

    // 返回结果
    function backToResult() {
        document.getElementById('wrongAnswersSection').classList.add('hidden');
        document.getElementById('resultSection').classList.remove('hidden');
    }
</script>
</body>
</html>

